<!DOCTYPE html>
<html>
<head>
  <style id="app-style">
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
    }

    .perspective {
      backface-visibility: hidden;
      transform-style: preserve-3d;
      position: fixed;
      top: 0;
      font-size: 0;
      left: 0;
      margin: 10%;
      background: transparent;
      width: 80%;
      height: 80%;
      perspective-origin: center;
      transform: rotateX(75deg) rotateZ(-20deg);
    }

    .background-board {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: #eeeeee80;
    }

    .container {
      display: inline-block;
      position: absolute;
      left: 50%;
      top: 50%;
      transform-style: preserve-3d;
    }

    .zft {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: block;
      background: transparent;
      transform-style: preserve-3d;
    }

    .zft span {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0% 0%;
      opacity: .5;
    }

    .zft span:nth-child(2) {
      transform: rotateX(90deg);
    }

    .zft span:nth-child(3) {
      transform: translateX(100%) rotateY(-90deg);
    }

    .zft span:nth-child(4) {
      transform: rotateY(-90deg);
    }

    .zft span:nth-child(5) {
      transform: translateY(100%) rotateX(90deg);
    }

    .zft.h1 span:nth-child(1),
    .zft.h2 span:nth-child(2),
    .zft.h3 span:nth-child(3),
    .zft.h4 span:nth-child(4),
    .zft.h5 span:nth-child(5),
    .zft.h6 span:nth-child(6) {
      background: transparent !important;
    }
  </style>
  <style id="var-style">
    .background-board {
      transform: translateZ(-90px);
    }

    .container {
      width: 60px;
      height: 60px;
      transform: translate3d(-50%, -50%, -30px);
    }

    .zft span:nth-child(6) {
      transform: translateZ(60px);
    }
  </style>
</head>

<body>
  <div class="perspective">
    <div class="background-board"></div>
    <div class="container"></div>
  </div>
</body>
<script src="./index.js"></script>
<script>
  const ReactData = new Proxy({ size: 60 }, {
    set(target, propKey, value) {
      switch (propKey) {
        case 'size':
          if (target[propKey] !== value) {
            const sheet = target.$varStyle.sheet
            sheet.removeRule(0)
            sheet.removeRule(0)
            sheet.removeRule(0)
            sheet.insertRule(`.zft span:nth-child(6) {transform: translateZ(${value}px);}`, 0)
            sheet.insertRule(`.container {width: ${value}px;height: ${value}px;transform: translate3d(-50%,-50%,-${value / 2}px);}`, 0)
            sheet.insertRule(`.background-board {transform: translateZ(-${value * 1.5 - (target.boardAbove || 0)}px);}`, 0)
          }
          break
        case 'boardAbove':
          if (target[propKey] !== value && typeof value === 'number') {
            sheet.removeRule(0)
            sheet.insertRule(`.background-board {transform: translateZ(-${value * 1.5 - (target.boardAbove || 0)}px);}`, 0)
          }
          break
        default:
          break
      }
      target[propKey] = value
      return true
    }
  })
  class One {
    constructor(parentNode, site) {
      const _this = this
      _this.site = [...site]
      _this.hideFace = {}
      parentNode.appendChild(_this.createEl())
      _this.style = new Proxy({}, {
        set(target, propKey, value) {
          if (typeof value === 'string' && target[propKey] !== value) {
            target[propKey] = value
            _this.upStyle(propKey, value)
            return true
          } else {
            return true
          }
        },
        deleteProperty(target, propKey) {
          delete target[propKey]
          _this.upStyle(propKey)
          return true
        }
      })
    }
    upStyle(key, value) {
      const childrenStyle = ['background', 'opacity']
      if (value !== void 0) {
        if (childrenStyle.includes(key)) {
          Array.prototype.forEach.call(this.el.children, node => {
            node.style.setProperty(key, value)
          })
        } else {
          this.el.style.setProperty(key, value)
        }
      } else {
        if (childrenStyle.includes(key)) {
          Array.prototype.forEach.call(this.el.children, node => {
            node.style.removeProperty(key)
          })
        } else {
          this.el.style.removeProperty(key)
        }
      }
    }
    styleobj2str(obj) {
      obj = obj || {}
      obj.width = obj.width || ReactData.size
      obj.height = obj.height || ReactData.size
      obj.transform = obj.transform || { translate: [] }
      for (let name in obj) {
        const value = obj[name]
        const tp = typeof value
        switch (name) {
          case 'width': case 'height':
            if (tp === 'number') {
              obj[name] = value + 'px'
            } else if (tp !== 'stirng') {
              delete obj[name]
            }
            break
          case 'transform':
            if (tp === 'object') {
              obj[name] = [value.translate ? `translate3d(${(this.site[2] - 1 + (value.translate[0] || 0)) * ReactData.size}px,${(this.site[1] - 1 + (value.translate[1] || 0)) * ReactData.size}px,${(this.site[0] - 1 + (value.translate[2] || 0)) * ReactData.size}px)` : '',
              value.rotate ? [
                value.rotate[0] ? `rotateX(${value.rotate[0]}deg)` : '',
                value.rotate[1] ? `rotateY(${value.rotate[1]}deg)` : '',
                value.rotate[2] ? `rotateZ(${value.rotate[2]}deg)` : ''].join(' ') : ''].join(' ')
            } else if (tp !== 'string') {
              delete obj[name]
            }
            break
          default:
            if (tp !== 'string') {
              delete obj[name]
            }
            break
        }
      }
      return Object.keys(obj).map(key => `${key}:${obj[key]}`).join(';')
    }
    createEl() {
      const zft = document.createElement('div')
      zft.className = 'zft'
      zft.style = this.styleobj2str()
      for (let i = 0; i < 6; i++) {
        zft.appendChild(document.createElement('span'))
      }
      this.el = zft
      return zft
    }
    setHideClass(noHide) {
      this.el.className = noHide ? 'zft' : ['zft', ...Object.keys(this.hideFace).map(item => item - -1)].join(' h')
    }
    hide() {
      this.upStyle('opacity', '0')
    }
    show() {
      this.upStyle('opacity', this.style.opacity || '0.8')
    }
  }

  class Block {
    constructor(numArr, luban, bgColor, parent, noHide) {
      this.arr = [...numArr]
      this.hub = {}
      this.parent = parent
      this.bgColor = bgColor
      numArr.map(item => nums2arrs(item)).forEach((a, ai) => {
        a.forEach((b, bi) => {
          b.forEach((c, ci) => {
            if (c) {
              const str = (ai + 1) * 1000 + [4, 2, 1][ci] * 10 ** (2 - bi)
              this.hub[str] = luban[2 - ai][bi][ci]
            }
          })
        })
      })
      this.setHideFace(bgColor, noHide)
    }

    setHideFace(color, noHide) {
      for (let point in this.hub) {
        const one = this.hub[point]
        const cp = points[point]
        for (let c in cp) {
          const p = cp[c]
          if (c in this.hub) {
            this.hub[c].hideFace[5 - p.cs] = point
            one.hideFace[p.cs] = c
          }
        }
      }
      for (let k in this.hub) {
        this.hub[k].style.background = color
        this.hub[k].show()
        this.hub[k].setHideClass(noHide)
      }
    }
    setStyle(style) {
      for (let k in this.hub) {
        Object.assign(this.hub[k].style, style)
      }
    }
    hideSelf() {
      for (let k in this.hub) {
        this.hub[k].hide()
      }
    }
    showSelf() {
      for (let k in this.hub) {
        this.hub[k].show()
      }
    }
    hideSelf() {
      for (let k in this.hub) {
        this.hub[k].hide()
      }
    }
    hideOther() {
      this.parent.forEach(item => {
        if (item !== this) {
          item.hideSelf()
        } else {
          item.showSelf()
        }
      })
    }
  }
  function ready(fn) {
    document.addEventListener('DOMContentLoaded', function readyFn() {
      document.removeEventListener('DOMContentLoaded', readyFn, false)
      fn()
    }, false)
  }
  ready(function () {
    function createBlock(arr) { // [1000, 2000, 3644]
      const group = document.createElement('div')
      arr.forEach((item, index) => {

      })
    }
    ReactData.$body = document.body
    ReactData.$pb = document.querySelector('.perspective')
    ReactData.$ct = document.querySelector('.container')
    ReactData.$varStyle = document.querySelector('#var-style')
    const { $body, $pb, $ct } = ReactData
    let r = 1
    let startPos = null
    let posRotate = [75, -20]
    if ($pb) {
      function mouseMove(event) {
        if (event.buttons !== 1) {
          $body.onmousemove = null
        } else {
          let dx = event.pageX - startPos[0]
          let dy = event.pageY - startPos[1]
          $pb.style.transform = `rotateX(${posRotate[0] - dy * r}deg) rotateZ(${posRotate[1] - dx * r}deg)`
        }
      }
      $body.onmousedown = function (event) {
        startPos = [event.pageX, event.pageY]
        $body.onmousemove = mouseMove
      }
      $body.onmouseup = function (event) {
        posRotate[1] -= event.pageX - startPos[0]
        posRotate[0] -= event.pageY - startPos[1]
        startPos = null
        $body.onmousemove = null
      }

      const luban = []

      function package(arr) { // [x7]
        return arr.map(item => new Block(item, luban))
      }

      const df = document.createDocumentFragment()
      for (let f = 2; f >= 0; f--) {
        luban[f] = luban[f] || []
        let floor = luban[f]
        for (let r = 0; r < 3; r++) {
          floor[r] = floor[r] || []
          let row = floor[r]
          for (let c = 0; c < 3; c++) {
            row[c] = new One(df, [f, r, c])
          }
        }
      }
      $ct.appendChild(df)
      ReactData.collection = {
        arr: [],
        load(data, colors, noHide) {
          this.show()
          this.arr.length = 0
          data.forEach((a, i) => this.arr.push(new Block(a, luban, (colors && colors[i]) || 'white', this.arr, noHide)))
        },
        show(indexs) {
          const isArr = Array.isArray(indexs)
          this.arr.forEach((item, index) => {
            if ((isArr && indexs.includes(index)) || index === indexs) {
              item.showSelf()
            } else {
              item.hideSelf()
            }
          })
        },
        hide(indexs) {
          const isArr = Array.isArray(indexs)
          this.arr.forEach((item, index) => {
            if ((isArr && indexs.includes(index)) || index === indexs) {
              item.hideSelf()
            } else {
              item.showSelf()
            }
          })
        },
      }
      ReactData.collection.load(
        /* [
          [1000, 2000, 3223],
          [1000, 2047, 3000],
          [1000, 2110, 3110],
          [1000, 2400, 3444],
          [1007, 2000, 3000],
          [1300, 2220, 3000],
          [1470, 2000, 3000],
        ] */
        [
          [1000, 2000, 3170],
          [1000, 2011, 3003],
          [1000, 2320, 3200],
          [1004, 2004, 3004],
          [1013, 2002, 3000],
          [1040, 2440, 3400],
          [1720, 2000, 3000]
        ]
/*         [
          [1000, 2000, 3017],
          [1000, 2017, 3000],
          [1000, 2200, 3640],
          [1000, 2460, 3020],
          [1000, 2660, 3000],
          [1007, 2000, 3000],
          [1110, 2100, 3100]
        ] */
        /* points2arrs([
          [1001, 1002, 1004],
          [1010, 1020, 1040, 1400],
          [1100, 1200, 2020, 2200],
          [2001, 2002, 2004, 2040],
          [2010, 2100, 3010, 3100],
          [2400, 3004, 3040, 3400],
          [3001, 3002, 3020, 3200]
        ]) */, ['red', 'orange', 'yellow', 'green', 'cyan', 'blue', 'purple']
      )
      let timer
      let n = null
      function hd() {
        timer = setTimeout(() => {
          ReactData.collection.show(n)
          n = n === 6 ? 0 : (n + 1)
          hd()
        }, 1500)
      }
      // hd()
      window.$luban = ReactData.collection
    }
  })
</script>
</html>